

# اصلاح الملخص التنفيذي والتوصيات واضافة اسم المشرف في PDF

## المشكلة الجذرية

الملخص التنفيذي والتوصيات فارغة لان قاعدة البيانات تحتوي على النص "لم يتم توليد ملخص" و "لم يتم توليد توصيات" - وهذه نصوص غير فارغة فعليا، فالنظام يعتبرها محتوى حقيقي ولا يقوم بتوليد بديل تلقائي.

## التغييرات المطلوبة

### ملف 1: `src/utils/exportReport.ts`

1. **اصلاح التحقق من الملخص والتوصيات**: اضافة النصوص الافتراضية ("لم يتم توليد ملخص"، "لم يتم توليد توصيات") الى قائمة القيم المعتبرة "فارغة"، بحيث يتم توليد ملخص تلقائي من الاحصائيات بدلا منها

2. **اضافة اسم المشرف في غلاف التقرير**: اضافة معامل جديد `coordinatorName` لدالة `buildPDFDocument` وعرضه في صفحة الغلاف تحت معلومات الفصل والعام الدراسي بصيغة "اعداد: [الاسم]"

3. **تحسين التوصيات التلقائية**: عند غياب توصيات AI، توليد توصيات مبنية على الاحصائيات (مثل: الاسئلة ذات المتوسط المنخفض تحتاج تحسين)

### ملف 2: `src/pages/Reports.tsx`

1. **جلب اسم المشرف**: استخدام `survey.created_by` للبحث في جدول `profiles` عن `full_name`، واستخراج الاسم من حقل الايميل اذا كان `full_name` فارغا (استخراج الجزء قبل @ وتنظيفه)

2. **تمرير اسم المشرف**: تمرير `coordinatorName` الى دوال `exportToPDF` و `generatePDFBlob`

3. **استدعاء AI عند التنزيل**: عند الضغط على PDF واذا كان الملخص والتوصيات فارغة (او تحتوي على النص الافتراضي)، استدعاء `analyze-survey` تلقائيا لتوليد محتوى حقيقي قبل التصدير

## التفاصيل التقنية

### استخراج اسم المشرف

```text
1. في loadReport، بعد جلب بيانات التقرير:
   - جلب profiles.full_name و profiles.email حيث id = survey.created_by
   - اذا كان full_name موجودا: استخدامه مباشرة
   - اذا لم يكن: استخراج الاسم من الايميل (الجزء قبل @، استبدال _ و . بمسافات)
   - حفظه في state جديد: coordinatorName

2. تمريره في preparePDFData و buildFilterInfo الى exportToPDF
```

### اصلاح التحقق من الملخص في exportReport.ts

```text
- تعريف قائمة النصوص "الفارغة":
  const EMPTY_TEXTS = ['لم يتم توليد ملخص', 'لم يتم توليد توصيات', 'لا يوجد ملخص تنفيذي']

- عند التحقق من summary:
  const isEmptySummary = !report?.summary || EMPTY_TEXTS.some(t => report.summary.includes(t))
  اذا كان فارغا -> توليد ملخص تلقائي من الاحصائيات

- عند التحقق من recommendations_text:
  const isEmptyRec = !report?.recommendations_text || EMPTY_TEXTS.some(t => report.recommendations_text.includes(t))
  اذا كان فارغا -> توليد توصيات تلقائية بناء على الاسئلة ذات الاداء المنخفض
```

### توليد توصيات تلقائية من الاحصائيات

```text
عند غياب توصيات AI:
1. ترتيب الاسئلة حسب المتوسط تصاعديا
2. لكل سؤال بمتوسط اقل من 3.5:
   "يوصى بتحسين جانب [نص السؤال المختصر] حيث بلغ المتوسط [X] من 5"
3. اذا كان المتوسط العام اقل من 3:
   "يوصى بمراجعة شاملة لجودة المقرر/البرنامج"
4. اذا كان المتوسط العام اعلى من 4:
   "النتائج تشير الى مستوى رضا عالٍ مع ضرورة الحفاظ على هذا المستوى"
```

### عرض اسم المشرف في الغلاف

```text
بعد معلومات الفصل والعام الدراسي:
- مستطيل رمادي فاتح يحتوي على "اعداد: [اسم المشرف]"
- بخط حجم 10 بلون COLORS.text
```

### لا تعديل على قاعدة البيانات
- لا حذف لاي بيانات سابقة
- لا تغيير في هيكل الجداول

### ملخص الملفات

| الملف | التغيير |
|-------|---------|
| `src/pages/Reports.tsx` | جلب اسم المشرف + تمريره للـ PDF |
| `src/utils/exportReport.ts` | اصلاح التحقق من النصوص الفارغة + اضافة اسم المشرف في الغلاف + توليد توصيات تلقائية |

