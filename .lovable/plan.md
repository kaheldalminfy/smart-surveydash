

# تحسين تصدير PDF حسب الفلتر مع Bar Charts وتوصيات AI لكل مقرر

## الهدف
1. تصدير PDF يعتمد على الفلتر المختار (المقرر الدراسي) مع اسم المقرر كعنوان
2. حذف سؤال الفلتر (اختيار المقرر) من التقرير
3. نسبة الاستجابة تعتمد على العدد اليدوي المدخل
4. Bar Chart واضح لكل سؤال ليكرت/تقييم مع بيانات تفصيلية
5. نقل الملخص التنفيذي والتوصيات الى نهاية التقرير
6. ضمان توليد توصيات AI عند اختيار "اعادة التحليل"
7. حفظ التوصيات مرتبطة بكل مقرر على حدة
8. لا تعديل على قاعدة البيانات

## الملفات المطلوب تعديلها

### 1. `src/pages/Reports.tsx`

**التغييرات:**

- **تمرير معلومات الفلتر لدوال PDF**: في `handleExportPDF` و `handlePreviewPDF`:
  - تحديد اسم المقرر من `filterValues` والسؤال المختار كفلتر
  - تمرير `manualEnrollment` و `filteredResponsesCount` كـ `filterInfo`
  - استبعاد السؤال المستخدم كفلتر من `detailedAnswers` عند تجهيز بيانات PDF
  - استخدام `filteredResponsesCount` بدلا من `allResponses.length` في `stats.totalResponses`
  - استخدام `manualEnrollment` في `stats.targetEnrollment` اذا كان مدخلا

- **تمرير بيانات التوزيع (distribution) لكل سؤال**: اضافة `distribution` و `mcqDistribution` الى `questionStats` حتى يتمكن PDF من رسم Bar Charts داخليا

- **اصلاح توليد توصيات AI**: في `generateReport` تمرير بيانات الفلتر (اسم المقرر) الى edge function حتى يولد توصيات مخصصة للمقرر

- **حفظ التوصيات لكل مقرر**: اضافة state `courseRecommendations` من نوع `Record<string, string>` لحفظ التوصيات المعدلة لكل مقرر. عند تغيير الفلتر يتم تحميل التوصيات المحفوظة لذلك المقرر. عند حفظ التوصيات يتم حفظها محليا مرتبطة باسم المقرر المختار

### 2. `src/utils/exportReport.ts`

**التغييرات في `exportToPDF` و `generatePDFBlob`:**

- **اضافة معامل `filterInfo`**: كائن اختياري يحتوي على `courseName`, `manualEnrollment`, `filteredCount`

- **تعديل صفحة الغلاف**: اذا وجد `filterInfo.courseName`، يظهر اسم المقرر كعنوان فرعي تحت عنوان الاستبيان

- **نسبة الاستجابة**: اذا وجد `filterInfo.manualEnrollment`، تحسب النسبة = `filteredCount / manualEnrollment * 100` مع الوان (اخضر >= 70%، اصفر 50-70%، برتقالي < 50%)

- **رسم Bar Chart لكل سؤال ليكرت/تقييم**:
  - لكل سؤال يتم رسم Bar Chart افقي باستخدام اشكال jsPDF الهندسية (rect)
  - 5 اعمدة بالوان: احمر (غير موافق بشدة)، برتقالي، اصفر، اخضر فاتح، اخضر غامق (موافق بشدة)
  - تحت كل عمود: العدد والنسبة المئوية
  - بجانب الرسم: المتوسط، الانحراف المعياري، التقييم (ممتاز/جيد/متوسط/ضعيف)

- **اعادة ترتيب اقسام التقرير**:
  ```text
  1. صفحة الغلاف (مع اسم المقرر)
  2. KPIs + جدول الاحصائيات
  3. ملخص متوسطات الاسئلة (Summary Chart)
  4. تحليل كل سؤال مع Bar Chart مرسوم + جدول توزيع
  5. الردود النصية
  6. الملخص التنفيذي (منقول للنهاية)
  7. التوصيات (منقول للنهاية)
  ```

### 3. `supabase/functions/analyze-survey/index.ts`

**التغييرات:**
- اضافة معامل اختياري `courseName` في body
- عند وجود `courseName`، تضمين اسم المقرر في prompt الذكاء الاصطناعي لتوليد توصيات مخصصة
- ضمان ان التوصيات تُولد دائما حتى لو لم تكن هناك ردود نصية (بالاعتماد على الاحصائيات الرقمية)

---

## البنية الجديدة لتقرير PDF

```text
صفحة 1: الغلاف
  - شعار الجامعة
  - عنوان الاستبيان
  - اسم المقرر الدراسي (العنوان الفرعي)
  - اسم البرنامج | الفصل | العام

صفحة 2: الاحصائيات
  - بطاقات KPI (مع نسبة استجابة يدوية)
  - جدول الاحصائيات

صفحة 3+: تحليل الاسئلة
  - لكل سؤال ليكرت/تقييم:
    - عنوان السؤال
    - Bar Chart مرسوم (5 اعمدة ملونة مع ارقام ونسب)
    - المتوسط + الانحراف + التقييم

صفحة الردود النصية

صفحة الملخص التنفيذي (في النهاية)
صفحة التوصيات (في النهاية)
```

## ملاحظات مهمة
- لا يوجد اي تعديل على قاعدة البيانات
- حفظ التوصيات لكل مقرر يتم محليا في state ويُحفظ في حقل `recommendations_text` الموجود اصلا في جدول reports
- جميع الازرار والوظائف الحالية محفوظة

