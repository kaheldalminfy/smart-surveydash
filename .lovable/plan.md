

# مطابقة الاستبيانات بالذكاء الاصطناعي في شاشة المقارنة

## المشكلة الحالية
المطابقة الحالية تعتمد على كلمات مفتاحية ثابتة في العنوان فقط (`SURVEY_TYPE_KEYWORDS`). هذا يفشل عندما تكون العناوين مختلفة لنفس النوع، مثل:
- "تقييم عضو هيئة التدريس للمقرر الدراسي" (ادارة المشاريع)
- "استبيان رضا عضو هيئة التدريس عن جودة المقرر الدراسي" (ادارة الرعاية الصحية)

بالرغم من ان الاسئلة متطابقة تقريبا (نفس اسئلة الليكرت عن المقرر والتدريس).

## الحل: مطابقة ذكية بالاسئلة + AI كـ fallback

### المنطق المقترح (بدون استدعاء AI في كل مرة لتوفير الكلفة):

**الخطوة 1: مطابقة بالاسئلة (Question Similarity)**
- عند جلب الاستبيانات، جلب اسئلة الليكرت/التقييم لكل استبيان
- حساب نسبة تشابه الاسئلة بين كل زوج من الاستبيانات عبر البرامج
- اذا كانت نسبة الاسئلة المتطابقة اكبر من 60%: يتم اعتبارهما نفس النوع

**الخطوة 2: مطابقة بالعنوان (كلمات مفتاحية محسنة)**
- توسيع قائمة الكلمات المفتاحية لتشمل الانماط الجديدة المكتشفة
- اذا لم تنجح مطابقة الاسئلة، استخدام العنوان كـ fallback

**الخطوة 3: AI Fallback (اختياري)**
- اذا بقيت استبيانات غير مطابقة، استدعاء edge function لتصنيفها بالذكاء الاصطناعي بناء على العنوان والاسئلة معا

### لماذا هذا افضل من استدعاء AI دائما؟
- اسرع: معظم الاستبيانات تتطابق بالاسئلة مباشرة
- ارخص: لا حاجة لاستدعاء AI اذا تمت المطابقة
- ادق: مقارنة الاسئلة الفعلية اكثر موثوقية من تحليل العنوان فقط

---

## التفاصيل التقنية

### ملف 1: `src/components/ProgramComparison.tsx` (تعديل)

**تغيير جلب البيانات**: اضافة جلب الاسئلة مع كل استبيان

```text
// بدلا من جلب responses فقط، جلب questions ايضا
surveys.select(`
  id, title,
  questions (id, text, type, order_index),
  responses (id, answers (numeric_value, questions (type)))
`)
```

**منطق المطابقة الجديد**:

```text
function matchSurveys(allSurveys: Map<programId, Survey[]>):
  1. لكل استبيان: استخراج نصوص اسئلة الليكرت/التقييم فقط
  2. بناء مجموعات (clusters):
     - البدء بالاستبيان الاول
     - لكل استبيان جديد: مقارنة اسئلته مع كل مجموعة موجودة
     - حساب التشابه = (عدد الاسئلة المتطابقة / اجمالي الاسئلة الفريدة)
     - اذا التشابه >= 0.5: اضافة للمجموعة
     - اذا لم يتطابق مع اي مجموعة: انشاء مجموعة جديدة
  3. تسمية كل مجموعة: استخدام اقصر عنوان استبيان في المجموعة بعد تنظيفه

function calculateTextSimilarity(questionsA: string[], questionsB: string[]):
  - تطبيع النصوص: ازالة المسافات الزائدة، علامات الترقيم
  - لكل سؤال في A: البحث عن تطابق في B (تطابق جزئي: includes او نسبة كلمات مشتركة > 70%)
  - النتيجة = عدد المتطابقات / max(طول A, طول B)
```

**تحسين الكلمات المفتاحية** (كـ fallback اضافي):

```text
SURVEY_TYPE_KEYWORDS المحدثة:
- اضافة: 'رضا عضو هيئة التدريس عن جودة', 'استبانة تقييم عضو هيئة التدريس'
- اضافة: 'نموذج تقييم الطلاب للمقرر', 'استبانة تقييم الطلاب للمقرر'
- اضافة: 'نموذج تقييم مدى رضا الطالب عن الامتحان'
- اضافة: 'تقييم جودة البرنامج الأكاديمي', 'تقييم البرنامج'
- اضافة: 'تقييم ورشة عمل', 'ورشة عمل للخريجين'
```

**التسمية الذكية للمجموعات**:
- بدلا من اظهار اول عنوان، استخدام تسمية مختصرة مشتقة من الكلمات المشتركة بين العناوين في المجموعة
- مثال: "تقييم عضو هيئة التدريس للمقرر" + "استبيان رضا عضو هيئة التدريس عن جودة المقرر" -> "رضا اعضاء هيئة التدريس عن المقررات"

### لا تعديل على قاعدة البيانات
- لا حذف لاي بيانات
- لا تغيير في هيكل الجداول
- جميع التغييرات في الواجهة الامامية فقط

---

## ملخص الملفات

| الملف | التغيير |
|-------|---------|
| `src/components/ProgramComparison.tsx` | مطابقة ذكية بالاسئلة + كلمات مفتاحية محسنة + تسمية مجموعات ذكية |

